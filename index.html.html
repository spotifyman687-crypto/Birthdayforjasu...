<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Happy Birthday</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --bg:#0c0a09;
      --glass: rgba(10, 10, 14, 0.55);
      --border: rgba(255,255,255,0.12);
      --text: rgba(245,245,245,0.92);
      --muted: rgba(245,245,245,0.72);
      --pink1:#ff4d8d;
      --red1:#ff2a3f;
      --shadow: 0 20px 60px rgba(0,0,0,0.55);
    }

    html,body{ height:100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      overflow-x:hidden;
      font-family: "Satoshi", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    .bgWrap{
      position: fixed;
      inset: 0;
      z-index: 0;
      overflow: hidden;
      background: var(--bg);
    }

    .aurora{
      position:absolute;
      inset:-20%;
      filter: blur(30px) saturate(1.15);
      opacity: 0.95;
      background:
        radial-gradient(60% 45% at 20% 30%, hsla(333,70%,55%,.4) 0%, transparent 60%),
        radial-gradient(55% 45% at 65% 35%, hsla(282, 82%, 54%, .3) 0%, transparent 60%),
        radial-gradient(55% 45% at 55% 75%, hsla(210, 89%, 60%, .3) 0%, transparent 60%),
        radial-gradient(60% 50% at 25% 80%, hsla(35, 90%, 60%, .3) 0%, transparent 60%);
      animation: auroraFlow 16s ease-in-out infinite;
      transform: translate3d(0,0,0);
    }

    .aurora::after{
      content:"";
      position:absolute;
      inset:-25%;
      filter: blur(34px) saturate(1.2);
      opacity: 0.75;
      background:
        radial-gradient(60% 45% at 70% 20%, hsla(333,70%,55%,.26) 0%, transparent 62%),
        radial-gradient(60% 45% at 25% 45%, hsla(282, 82%, 54%, .22) 0%, transparent 62%),
        radial-gradient(60% 45% at 65% 75%, hsla(210, 89%, 60%, .22) 0%, transparent 62%),
        radial-gradient(60% 45% at 35% 85%, hsla(35, 90%, 60%, .22) 0%, transparent 62%);
      animation: auroraFlow2 19s ease-in-out infinite;
      transform: translate3d(0,0,0);
      mix-blend-mode: screen;
    }

    @keyframes auroraFlow{
      0%   { transform: translate(-2%, -1%) scale(1.05) rotate(0deg); }
      25%  { transform: translate(2%, -2%) scale(1.10) rotate(6deg); }
      50%  { transform: translate(3%, 2%)  scale(1.06) rotate(0deg); }
      75%  { transform: translate(-3%, 2%) scale(1.12) rotate(-6deg); }
      100% { transform: translate(-2%, -1%) scale(1.05) rotate(0deg); }
    }

    @keyframes auroraFlow2{
      0%   { transform: translate(2%, 2%) scale(1.10) rotate(0deg); }
      25%  { transform: translate(-2%, 3%) scale(1.06) rotate(-7deg); }
      50%  { transform: translate(-3%, -2%) scale(1.12) rotate(0deg); }
      75%  { transform: translate(3%, -2%) scale(1.07) rotate(7deg); }
      100% { transform: translate(2%, 2%) scale(1.10) rotate(0deg); }
    }

    #threeCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      z-index: 1;
      pointer-events:none;
    }

    .vignette{
      position:absolute;
      inset:0;
      z-index:2;
      pointer-events:none;
      background:
        radial-gradient(70% 60% at 50% 40%, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.45) 70%, rgba(0,0,0,0.70) 100%);
    }

    #confettiCanvas{
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 60;
      pointer-events: none;
    }

    .progressWrap{
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: min(560px, calc(100vw - 20px));
      height: 10px;
      z-index: 50;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      backdrop-filter: blur(14px);
      border-radius: 999px;
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }

    .progressFill{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, var(--pink1), var(--red1));
      border-radius: 999px;
      box-shadow: 0 0 18px rgba(255, 70, 140, 0.55);
      transition: width 700ms cubic-bezier(.2,.9,.2,1);
    }

    .glassCard{
      background: var(--glass);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      border-radius: 24px;
      overflow:hidden;
    }

    .heading{
      font-family: "Playfair Display", ui-serif, Georgia, "Times New Roman", serif;
      letter-spacing: 0.2px;
      background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,180,210,0.95), rgba(255,255,255,0.92));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .muted{ color: var(--muted); }

    .step{
      position: absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 76px 14px 22px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px) scale(0.98);
    }

    .step.active{
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0px) scale(1);
    }

    .bigIcon{
      font-size: 54px;
      line-height: 1;
      filter: drop-shadow(0 0 18px rgba(255, 70, 140, 0.35));
    }

    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.28);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(14px);
      color: rgba(245,245,245,0.78);
      font-weight: 700;
      font-size: 12px;
    }

    .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.55);
      box-shadow: 0 0 12px rgba(255, 70, 140, 0.25);
    }

    .dot.live{
      background: rgba(255, 70, 140, 0.9);
      box-shadow: 0 0 16px rgba(255, 70, 140, 0.55);
    }

    .candleStage{
      width: min(560px, 94vw);
      margin: 0 auto;
      padding: 16px 10px 4px;
    }

    .candlePlate{
      width: min(520px, 92vw);
      margin: 0 auto;
      border-radius: 22px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 60px rgba(0,0,0,0.40);
      padding: 18px 12px 16px;
    }

    .candleRow{
      display:flex;
      align-items:flex-end;
      justify-content:center;
      gap: 16px;
      padding: 8px 0 6px;
      flex-wrap: wrap;
    }

    .candle{
      width: 34px;
      height: 108px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255, 205, 225, 0.92));
      position: relative;
      box-shadow: 0 16px 28px rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.35);
    }

    @media (max-width: 420px){
      .candle{ width: 30px; height: 98px; }
      .candleRow{ gap: 12px; }
    }

    .wick{
      position:absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 14px;
      border-radius: 999px;
      background: rgba(25,25,25,0.85);
    }

    .flame{
      position:absolute;
      top: -42px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 40% 30%, rgba(255,255,255,0.95) 0%, rgba(255, 220, 120, 0.95) 30%, rgba(255, 105, 80, 0.92) 62%, rgba(255, 42, 109, 0.0) 75%);
      filter: blur(0.2px) drop-shadow(0 0 18px rgba(255, 170, 80, 0.55));
      opacity: 1;
      transform-origin: 50% 85%;
    }

    .flame.off{
      opacity: 0;
      transform: translateX(-50%) scale(0.6);
      filter: blur(1px);
    }

    .miniGlass{
      background: rgba(8, 8, 12, 0.45);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(16px);
      border-radius: 18px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.45);
    }

    .bento{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 640px){
      .bento{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .polaroidWrap{
      perspective: 900px;
      width: 100%;
    }

    .polaroid{
      width: min(520px, 92vw);
      background: rgba(255,255,255,0.96);
      border-radius: 18px;
      box-shadow: 0 26px 80px rgba(0,0,0,0.45);
      transform-style: preserve-3d;
      transform: rotateX(6deg) rotateY(-10deg);
      transition: transform 180ms ease;
      overflow:hidden;
      margin: 0 auto;
    }

    .polaroidInner{ padding: 14px 14px 16px; }

    .polaroidImg{
      width:100%;
      height: auto;
      border-radius: 12px;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
    }

    .polaroidCaption{
      color: rgba(20,20,22,0.80);
      margin-top: 10px;
      font-weight: 800;
      letter-spacing: 0.2px;
      text-align: center;
    }

    .glowBtn{
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 22px;
      border-radius: 999px;
      font-weight: 800;
      color: white;
      background: linear-gradient(90deg, var(--pink1), var(--red1));
      box-shadow:
        0 10px 26px rgba(255, 46, 112, 0.25),
        0 0 18px rgba(255, 46, 112, 0.35);
      transition: transform 220ms ease, box-shadow 220ms ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .glowBtn::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255, 77, 141, 0.45), rgba(255, 42, 63, 0.45));
      filter: blur(14px);
      opacity: 0.7;
      z-index:-1;
      transition: opacity 220ms ease, filter 220ms ease;
    }

    .glowBtn:hover{
      transform: translateY(-2px) scale(1.05);
      box-shadow:
        0 14px 34px rgba(255, 46, 112, 0.30),
        0 0 22px rgba(255, 46, 112, 0.55);
    }

    .glowBtn:active{ transform: translateY(0px) scale(0.99); }

    .glowBtn[disabled]{ opacity: 0.55; cursor: not-allowed; }

    .finalLine{
      opacity: 0;
      transform: translateY(10px);
    }

    @media (prefers-reduced-motion: reduce){
      .aurora, .aurora::after{ animation: none !important; }
      .glowBtn{ transition: none !important; }
    }
  </style>
</head>

<body>
  <div class="bgWrap" aria-hidden="true">
    <div class="aurora"></div>
    <canvas id="threeCanvas"></canvas>
    <div class="vignette"></div>
  </div>

  <canvas id="confettiCanvas"></canvas>

  <div class="progressWrap" role="progressbar" aria-label="Progress">
    <div class="progressFill" id="progressFill"></div>
  </div>

  <main class="relative z-10 min-h-screen">
    <section id="stepsRoot" class="relative min-h-screen">

      <!-- Step 1: Candles first -->
      <div class="step active" data-step="1" id="step1">
        <div class="glassCard w-full max-w-3xl p-6 sm:p-10">
          <div class="flex flex-col items-center text-center gap-5">
            <div class="bigIcon">üïØÔ∏è</div>
            <h1 class="heading text-3xl sm:text-5xl">Make a Wish</h1>
            <p class="muted text-base sm:text-lg leading-relaxed max-w-2xl">
              Blow into your microphone to put the flames out. If the mic is blocked, tap any candle to blow them out.
            </p>

            <div class="flex items-center justify-center gap-3">
              <div class="statusPill" id="micPill">
                <span class="dot" id="micDot"></span>
                <span id="micText">Mic not started</span>
              </div>
            </div>

            <div class="candleStage">
              <div class="candlePlate">
                <div class="candleRow" id="candleRow">
                  <div class="candle" data-candle><div class="wick"></div><div class="flame" data-flame></div></div>
                  <div class="candle" data-candle><div class="wick"></div><div class="flame" data-flame></div></div>
                  <div class="candle" data-candle><div class="wick"></div><div class="flame" data-flame></div></div>
                  <div class="candle" data-candle><div class="wick"></div><div class="flame" data-flame></div></div>
                  <div class="candle" data-candle><div class="wick"></div><div class="flame" data-flame></div></div>
                </div>
                <div class="mt-3 text-center muted text-sm">
                  Tip: Fu gar vayana vaney Start Microphone click gar ani candel ma click gar.
                </div>
              </div>
            </div>

            <button class="glowBtn mt-1" id="startMicBtn">Start Microphone</button>
          </div>
        </div>
      </div>

      <div class="step" data-step="2" id="step2">
        <div class="glassCard w-full max-w-2xl p-6 sm:p-10">
          <div class="flex flex-col items-center text-center gap-5">
            <div class="bigIcon">üéâ</div>
            <h2 class="heading text-4xl sm:text-5xl">Happy Birthday!</h2>
            <p class="muted text-base sm:text-lg leading-relaxed max-w-xl">
              Happy birthday my love i feel so luckey to have you, taila sochako sabai pura hos.
              I cant never imagine ke ma ta bela k gartheya vanera aila samma you are the most 
              beautiful things i have ever get or dream of, jaba ta mero life ma aais teti khera
              bata ma sano jura ma ne khusi hunu thaley, ta hasako, ta ma sanga vako dekhda malai special
              feel hunxa jasu. Aila ta ja garda ne smile gare ra hunxu because i have you in my life, 
              malai xodera janey kam chai na gar haii sayad ma ta bena basna ne sakdena hola aba.
              I just want you in my life baby.
        
            </p>
            <button class="glowBtn mt-1" data-next>Keep going</button>
          </div>
        </div>
      </div>

      <div class="step" data-step="3" id="step3">
        <div class="glassCard w-full max-w-3xl p-6 sm:p-10">
          <div class="flex flex-col items-center text-center gap-6">
            <h2 class="heading text-3xl sm:text-4xl">You</h2>

            <div class="bento w-full text-left">
              <div class="miniGlass p-5 sm:p-6 col-span-4 sm:col-span-2">
                <div class="text-lg font-bold text-slate-100">Date</div>
                <div class="muted mt-2 leading-relaxed">
                  31th January 2026 From ADISHU
                </div>
              </div>

              <div class="miniGlass p-5 sm:p-6 col-span-2 sm:col-span-2">
                <div class="text-lg font-bold text-slate-100">Our</div>
                <div class="muted mt-2 leading-relaxed">
                    1st Birthday Together.
                </div>
              </div>

              <div class="miniGlass p-5 sm:p-6 col-span-4 sm:col-span-2">
                <div class="text-lg font-bold text-slate-100">Special Day</div>
                <div class="muted mt-2 leading-relaxed">
                  Today and Mrch 18 2025.
                </div>
              </div>
            </div>

            <button class="glowBtn mt-1" data-next>One memory</button>
          </div>
        </div>
      </div>

      <div class="step" data-step="4" id="step4">
        <div class="glassCard w-full max-w-3xl p-6 sm:p-10">
          <div class="flex flex-col items-center text-center gap-6">
            <h2 class="heading text-3xl sm:text-4xl">Best Moment with you</h2>

            <div class="polaroidWrap flex items-center justify-center">
              <div class="polaroid" id="polaroid">
                <div class="polaroidInner">
                  <img
                    class="polaroidImg"
                    src="image.png/Screenshot 2026-01-30 233724.png"
                    alt="A sweet memory"
                    loading="lazy"
                  />
                  <div class="polaroidCaption">A sweet memory.</div>
                </div>
              </div>
            </div>

            <p class="muted text-base sm:text-lg leading-relaxed max-w-2xl">
              I woould never forget this moment this was the most special moment for me because
              maila talai yesto happy aila samma dhekako thena, yop were so happy 
              and i cannot even express my felling ke ma k feel gare ra theya teti khera.
              I was so happy seeing you that happy you were just smilling more than 5 minutes, 
              i dont know baby malai express ne garna ako xina ma testo happy feel gare ra theya teti khera.
              
            </p>

            <button class="glowBtn mt-1" data-next>Final wish</button>
          </div>
        </div>
      </div>

      <div class="step" data-step="5" id="step5">
        <div class="glassCard w-full max-w-2xl p-6 sm:p-10">
          <div class="flex flex-col items-center text-center gap-5">
            <div class="bigIcon">üéÇ</div>
            <h2 class="heading text-3xl sm:text-4xl">My Wish For You</h2>
            <h3 class="muted text-base sm:text-lg leading-relaxed max-w-xl">
              Happy birthday jasu üéâ Wishing you a year filled with love, joy and all the things that make you smile.
              Today is your birthday baby and i am so much excited more than you can imagine.
              I am felling so excited more than you in your birthday and i feel lucky that i get to have you in my life.
              Your smile, your laugh and the way you dance for me yesterday makes me feeels so so so special.
              Jaba ma ta sange hunxu i dont care what bad is happining in my life in that time i just want to be with you
              spend time with you and just be with you.
            </h3>

              Happy birthday my love ‚ù§Ô∏è. I dont want to see you cry today so just enjoy today dont think any negative 
              enjoy your birthday. I love you so so so much ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è.......... 
             </h3>

            <div id="finalLine" class="finalLine heading text-3xl sm:text-4xl mt-2">
              HAPPY BIRTHDAY JASU MY SWEET POTATO MY ANGEL MY LOVE ‚ù§Ô∏è.....
            </div>

            <button class="glowBtn mt-1" id="celebrateBtn">I LOVE YOU TOO ADISHU</button>
          </div>
        </div>
      </div>

    </section>
  </main>

  <script>
    (function () {
      const steps = Array.from(document.querySelectorAll(".step"));
      const progressFill = document.getElementById("progressFill");
      const celebrateBtn = document.getElementById("celebrateBtn");
      const finalLine = document.getElementById("finalLine");

      let currentIndex = 0;
      const totalSteps = steps.length;

      function setProgress(index){
        const pct = Math.round(((index + 1) / totalSteps) * 100);
        progressFill.style.width = pct + "%";
      }

      function animateStepIn(stepEl){
        const items = stepEl.querySelectorAll("h1, h2, p, button, .bento, .polaroidWrap, .bigIcon, .candleStage, .statusPill, #finalLine");
        gsap.fromTo(stepEl,
          { opacity: 0, y: 16, scale: 0.985 },
          { opacity: 1, y: 0, scale: 1, duration: 0.65, ease: "power3.out" }
        );
        gsap.fromTo(items,
          { opacity: 0, y: 10 },
          { opacity: 1, y: 0, duration: 0.6, ease: "power3.out", stagger: 0.05, delay: 0.08 }
        );
      }

      function animateStepOut(stepEl){
        return gsap.to(stepEl, { opacity: 0, y: 10, scale: 0.98, duration: 0.45, ease: "power2.inOut" });
      }

      function showStep(index){
        if(index < 0 || index >= totalSteps) return;
        const current = steps[currentIndex];
        const next = steps[index];
        if(current === next) return;

        current.classList.remove("active");
        next.classList.add("active");

        animateStepIn(next);
        setProgress(index);
        currentIndex = index;

        if(next.id === "step1"){
          startFlameFlicker();
          startFireworks(); // fireworks always running from start
        }
      }

      function goNext(){
        const current = steps[currentIndex];
        animateStepOut(current).then(() => {
          showStep(Math.min(currentIndex + 1, totalSteps - 1));
        });
      }

      document.querySelectorAll("[data-next]").forEach(btn => btn.addEventListener("click", goNext));

      setProgress(0);
      animateStepIn(steps[0]);

      const polaroid = document.getElementById("polaroid");
      if(polaroid){
        const maxRotate = 10;
        function handleMove(e){
          const rect = polaroid.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          const px = (x / rect.width) * 2 - 1;
          const py = (y / rect.height) * 2 - 1;
          gsap.to(polaroid, { rotateX: -py * maxRotate, rotateY: px * maxRotate, duration: 0.25, ease: "power2.out" });
        }
        function handleLeave(){
          gsap.to(polaroid, { rotateX: 6, rotateY: -10, duration: 0.5, ease: "power3.out" });
        }
        polaroid.addEventListener("mousemove", handleMove);
        polaroid.addEventListener("mouseleave", handleLeave);
        polaroid.addEventListener("touchmove", (e) => {
          const t = e.touches[0];
          if(!t) return;
          handleMove({ clientX: t.clientX, clientY: t.clientY });
        }, { passive: true });
        polaroid.addEventListener("touchend", handleLeave, { passive: true });
      }

      const confettiCanvas = document.getElementById("confettiCanvas");
      const confettiEngine = confetti.create(confettiCanvas, { resize: true, useWorker: true });

      function burstFirework(){
        const x = Math.random() * 0.9 + 0.05;
        const y = Math.random() * 0.45 + 0.05;
        confettiEngine({
          particleCount: 80 + Math.floor(Math.random() * 60),
          spread: 70,
          startVelocity: 32,
          ticks: 240,
          gravity: 0.95,
          scalar: 0.95,
          origin: { x, y }
        });
      }

      let fireworksTimer = null;
      function startFireworks(){
        if(fireworksTimer) return;
        fireworksTimer = setInterval(() => {
          burstFirework();
          if(Math.random() < 0.35) setTimeout(burstFirework, 220);
        }, 900);
      }

      function stopFireworks(){
        if(!fireworksTimer) return;
        clearInterval(fireworksTimer);
        fireworksTimer = null;
      }

      function runFinale(){
        celebrateBtn.disabled = true;
        gsap.to(celebrateBtn, { opacity: 0, y: 6, duration: 0.35, ease: "power2.out" });
        gsap.to(finalLine, { opacity: 1, y: 0, duration: 0.8, ease: "power3.out", delay: 0.25 });
        for(let i=0;i<6;i++) setTimeout(burstFirework, i*180);
        setHeartsFinale();
      }

      celebrateBtn.addEventListener("click", runFinale);

      const flames = Array.from(document.querySelectorAll("[data-flame]"));
      const candles = Array.from(document.querySelectorAll("[data-candle]"));
      const startMicBtn = document.getElementById("startMicBtn");
      const micText = document.getElementById("micText");
      const micDot = document.getElementById("micDot");

      let micStream = null;
      let audioCtx = null;
      let analyser = null;
      let dataArray = null;
      let micLoop = null;
      let blown = false;

      function rand(min, max){ return min + Math.random() * (max - min); }

      function startFlameFlicker(){
        flames.forEach((f, i) => {
          gsap.to(f, {
            scaleY: 1.02,
            scaleX: 0.98,
            rotation: () => rand(-10, 10),
            duration: 0.14 + (i * 0.01),
            yoyo: true,
            repeat: -1,
            ease: "sine.inOut",
            transformOrigin: "50% 85%"
          });
        });
      }

      function setMicStatus(label, live){
        micText.textContent = label;
        live ? micDot.classList.add("live") : micDot.classList.remove("live");
      }

      async function startMic(){
        try{
          setMicStatus("Requesting mic‚Ä¶", false);
          micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });

          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const src = audioCtx.createMediaStreamSource(micStream);
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 2048;
          src.connect(analyser);

          dataArray = new Uint8Array(analyser.fftSize);
          setMicStatus("Mic ready, blow now", true);

          if(micLoop) cancelAnimationFrame(micLoop);
          monitorBlow();
        } catch(e){
          setMicStatus("Mic blocked, tap candles", false);
        }
      }

      function rmsFromTimeDomain(arr){
        let sum = 0;
        for(let i=0; i<arr.length; i++){
          const v = (arr[i] - 128) / 128;
          sum += v * v;
        }
        return Math.sqrt(sum / arr.length);
      }

      function extinguishAll(){
        if(blown) return;
        blown = true;

        flames.forEach(f => f.classList.add("off"));

        confettiEngine({
          particleCount: 90,
          spread: 70,
          startVelocity: 28,
          ticks: 200,
          gravity: 1.02,
          origin: { x: 0.5, y: 0.65 }
        });

        setMicStatus("Candles out", false);

        setTimeout(() => {
          stopMic();
          goNext(); // AUTO GO TO NEXT PAGE AFTER BLOWING
        }, 900);
      }

      function monitorBlow(){
        if(!analyser || !dataArray) return;

        analyser.getByteTimeDomainData(dataArray);
        const level = rmsFromTimeDomain(dataArray);

        const blowThreshold = 0.13;
        const strongBlow = 0.16;

        if(!blown){
          if(level > strongBlow){
            extinguishAll();
          } else {
            if(level > blowThreshold) setMicStatus("Nice, keep blowing", true);
            else setMicStatus("Mic ready, blow now", true);
          }
        }

        micLoop = requestAnimationFrame(monitorBlow);
      }

      function stopMic(){
        try{
          if(micLoop) cancelAnimationFrame(micLoop);
          micLoop = null;

          if(micStream){
            micStream.getTracks().forEach(t => t.stop());
            micStream = null;
          }
          if(audioCtx){
            audioCtx.close();
            audioCtx = null;
          }
          analyser = null;
          dataArray = null;
        } catch(e){}
      }

      startMicBtn.addEventListener("click", () => {
        startFireworks(); // ensure fireworks running
        startMic();
      });

      candles.forEach(c => {
        c.addEventListener("click", () => {
          startFireworks();
          if(!blown) extinguishAll();
        });
        c.addEventListener("touchstart", () => {
          startFireworks();
          if(!blown) extinguishAll();
        }, { passive: true });
      });

      window.addEventListener("visibilitychange", () => { if(document.hidden) stopMic(); });

      /* Three.js floating hearts background */
      const threeCanvas = document.getElementById("threeCanvas");
      const renderer = new THREE.WebGLRenderer({ canvas: threeCanvas, alpha: true, antialias: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
      camera.position.set(0, 0, 10);

      scene.add(new THREE.AmbientLight(0xffffff, 0.65));
      const keyLight = new THREE.DirectionalLight(0xffffff, 0.9);
      keyLight.position.set(3, 4, 6);
      scene.add(keyLight);

      const fillLight = new THREE.DirectionalLight(0xff86b3, 0.45);
      fillLight.position.set(-4, -1, 4);
      scene.add(fillLight);

      function createHeartGeometry(){
        const x = 0, y = 0;
        const heartShape = new THREE.Shape();
        heartShape.moveTo(x + 0.0, y + 0.25);
        heartShape.bezierCurveTo(x + 0.0, y + 0.25, x - 0.25, y + 0.05, x - 0.5, y + 0.05);
        heartShape.bezierCurveTo(x - 0.95, y + 0.05, x - 0.95, y + 0.6, x - 0.95, y + 0.6);
        heartShape.bezierCurveTo(x - 0.95, y + 0.95, x - 0.6, y + 1.2, x + 0.0, y + 1.5);
        heartShape.bezierCurveTo(x + 0.6, y + 1.2, x + 0.95, y + 0.95, x + 0.95, y + 0.6);
        heartShape.bezierCurveTo(x + 0.95, y + 0.6, x + 0.95, y + 0.05, x + 0.5, y + 0.05);
        heartShape.bezierCurveTo(x + 0.25, y + 0.05, x + 0.0, y + 0.25, x + 0.0, y + 0.25);

        const extrudeSettings = {
          depth: 0.25,
          bevelEnabled: true,
          bevelThickness: 0.08,
          bevelSize: 0.06,
          bevelSegments: 3,
          curveSegments: 24,
          steps: 1
        };

        const geo = new THREE.ExtrudeGeometry(heartShape, extrudeSettings);
        geo.center();
        return geo;
      }

      const heartGeo = createHeartGeometry();
      const hearts = [];
      const heartCount = 24;

      function rand(min, max){ return min + Math.random() * (max - min); }

      for(let i=0; i<heartCount; i++){
        const hue = rand(340, 360);
        const mat = new THREE.MeshStandardMaterial({
          color: new THREE.Color(`hsl(${hue}, 85%, ${rand(55, 62)}%)`),
          metalness: 0.35,
          roughness: 0.25,
          transparent: true,
          opacity: 0.9
        });

        const mesh = new THREE.Mesh(heartGeo, mat);
        const s = rand(0.35, 0.9);
        mesh.scale.set(s, s, s);

        mesh.position.set(rand(-6, 6), rand(-4, 4), rand(-7, -1));
        mesh.rotation.set(rand(0, Math.PI), rand(0, Math.PI), rand(0, Math.PI));

        mesh.userData = {
          baseX: mesh.position.x,
          baseY: mesh.position.y,
          baseZ: mesh.position.z,
          drift: rand(0.6, 1.4),
          phase: rand(0, Math.PI * 2)
        };

        scene.add(mesh);
        hearts.push(mesh);
      }

      let celebrateMode = false;

      function setHeartsFinale(){
        celebrateMode = true;
        hearts.forEach((h, idx) => {
          const sign = idx % 2 === 0 ? 1 : -1;
          const targetX = h.position.x + sign * rand(2.5, 6.5);
          const targetY = h.position.y + rand(4.5, 9.0);
          const targetZ = h.position.z + rand(-1.5, 1.5);

          gsap.to(h.position, { x: targetX, y: targetY, z: targetZ, duration: rand(2.2, 3.2), ease: "power2.out" });
          gsap.to(h.rotation, { x: h.rotation.x + rand(1.8, 3.2), y: h.rotation.y + rand(1.8, 3.2), z: h.rotation.z + rand(1.8, 3.2), duration: rand(2.2, 3.1), ease: "power2.out" });
          gsap.to(h.material, { opacity: 0, duration: rand(2.2, 3.0), ease: "power2.out", delay: rand(0.2, 0.7) });
          gsap.to(h.scale, { x: h.scale.x * 0.7, y: h.scale.y * 0.7, z: h.scale.z * 0.7, duration: rand(2.0, 3.0), ease: "power2.out" });
        });
      }

      window.addEventListener("resize", () => {
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      });

      function animate(){
        requestAnimationFrame(animate);
        const t = performance.now() * 0.001;

        hearts.forEach((h) => {
          if(!celebrateMode){
            const d = h.userData.drift;
            const p = h.userData.phase;
            h.position.x = h.userData.baseX + Math.sin(t * 0.7 * d + p) * 0.35;
            h.position.y = h.userData.baseY + Math.cos(t * 0.6 * d + p) * 0.25;
            h.rotation.y += 0.0025;
            h.rotation.x += 0.0018;
          }
        });

        renderer.render(scene, camera);
      }
      animate();

      startFlameFlicker();
      startFireworks(); // FIREWORKS ALL THE TIME from page load
    })();
  </script>
</body>
</html>
